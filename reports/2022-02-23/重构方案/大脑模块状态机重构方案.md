# 大脑模块状态机重构方案

**创建日期**: 2026-02-23  
**作者**: GLM-5  
**状态**: 方案设计阶段

---

## 一、当前问题分析

### 1.1 现有代码结构

```
post() 方法处理流程（简化）:

┌─────────────────────────────────────────────────────────────────────┐
│  post()                                                             │
│  ├── parseCapabilityPrefix() → 直接跳转到主意识处理                  │
│  ├── contextPreparer.Prepare()                                      │
│  ├── leftBrain.Think()                                              │
│  ├── if HasSchedule → 返回定时任务结果                               │
│  ├── if !Useless || hasValidIntent                                  │
│  │   └── tryRightBrainProcess()                                     │
│  │       ├── toolsRequest()                                         │
│  │       └── toolCaller.ExecuteToolCall()                           │
│  ├── if !CanAnswer                                                  │
│  │   └── activateConsciousness()                                    │
│  │       ├── if capability found                                    │
│  │       │   └── activateConsciousnessWithCapability()              │
│  │       │       ├── consciousnessMgr.Create()                      │
│  │       │       ├── consciousnessWithTools() 或 consciousnessMgr.Think()│
│  │       │       └── fallbackHandler.Handle() [on error]            │
│  │       └── else                                                   │
│  │           └── activateConsciousnessDualBrain()                   │
│  │               ├── consciousnessMgr.CreateDualBrain()             │
│  │               ├── leftBrain.Think()                              │
│  │               └── tryConsciousnessRightBrainProcess()            │
│  └── return BuildLeftBrainResponse()                                │
└─────────────────────────────────────────────────────────────────────┘
```

### 1.2 问题清单

| 问题 | 影响 | 严重程度 |
|------|------|----------|
| **嵌套层级深** | `post()` 方法超过 200 行，嵌套 4-5 层 | 高 |
| **状态隐式** | 当前处理阶段难以追踪，调试困难 | 高 |
| **错误处理分散** | 多处 `if err != nil` 且处理方式不一致 | 中 |
| **回退逻辑耦合** | `fallbackHandler` 在多处被调用，逻辑重复 | 中 |
| **测试困难** | 需要模拟复杂的条件组合才能覆盖所有路径 | 高 |
| **EventChan 管理分散** | `SetEventChan(nil)` 在多个分支中重复调用 | 低 |

---

## 二、状态机设计方案

### 2.1 状态定义

```go
type BrainState string

const (
    StateInitial                  BrainState = "initial"
    StatePreparingContext         BrainState = "preparing_context"
    StateLeftBrainThinking        BrainState = "left_brain_thinking"
    StateCheckingSchedule         BrainState = "checking_schedule"
    StateRightBrainProcessing     BrainState = "right_brain_processing"
    StateConsciousnessActivating  BrainState = "consciousness_activating"
    StateConsciousnessWithCap     BrainState = "consciousness_with_capability"
    StateConsciousnessDualBrain   BrainState = "consciousness_dual_brain"
    StateFallback                 BrainState = "fallback"
    StateCompleted                BrainState = "completed"
    StateError                    BrainState = "error"
)
```

### 2.2 事件定义

```go
type BrainEvent string

const (
    EventStart              BrainEvent = "start"
    EventContextPrepared    BrainEvent = "context_prepared"
    EventLeftBrainComplete  BrainEvent = "left_brain_complete"
    EventScheduleDetected   BrainEvent = "schedule_detected"
    EventToolsFound         BrainEvent = "tools_found"
    EventNoToolsFound       BrainEvent = "no_tools_found"
    EventCanAnswer          BrainEvent = "can_answer"
    EventCannotAnswer       BrainEvent = "cannot_answer"
    EventCapabilityFound    BrainEvent = "capability_found"
    EventNoCapabilityFound  BrainEvent = "no_capability_found"
    EventProcessingComplete BrainEvent = "processing_complete"
    EventError              BrainEvent = "error"
    EventFallbackRequired   BrainEvent = "fallback_required"
)
```

### 2.3 状态转换图

```
┌─────────┐    Start    ┌─────────────────┐    ContextPrepared    ┌──────────────────────┐
│ Initial │ ──────────▶ │ PreparingContext│ ────────────────────▶ │ LeftBrainThinking    │
└─────────┘             └─────────────────┘                       └──────────┬───────────┘
                                                                             │
                     ┌───────────────────────────────────────────────────────┼───────────────────┐
                     │                                                       │                   │
                     ▼                                                       ▼                   ▼
           ScheduleDetected                                          LeftBrainComplete        Error
              (HasSchedule)                                         (CanAnswer && !Useless)        │
                     │                                                       │                   │
                     ▼                                                       ▼                   │
            ┌────────────────┐                                              │                   │
            │ Completed      │                                              │                   │
            │ (定时任务结果)  │                                              │                   │
            └────────────────┘                                              │                   │
                                          ┌─────────────────────────────────┴───────────────┐
                                          │                                                 │
                                          ▼                                                 ▼
                                   CanAnswer                                           CannotAnswer
                                          │                                                 │
                                          ▼                                                 │
                                 ┌────────────────┐                                        │
                                 │ Completed      │                                        │
                                 │ (左脑直接回答)  │                                        │
                                 └────────────────┘                                        │
                                                                                           │
                                      ┌────────────────────────────────────────────────────┤
                                      │                                                    │
                                      ▼                                                    ▼
                               ToolsFound                                           NoToolsFound
                                      │                                                    │
                                      ▼                                                    │
                          ┌──────────────────────┐                                       │
                          │ RightBrainProcessing │                                       │
                          └──────────┬───────────┘                                       │
                                     │                                                   │
                     ┌───────────────┴───────────────┐                                   │
                     │                               │                                   │
                     ▼                               ▼                                   │
            ProcessingComplete               CannotAnswer                                │
                     │                      (工具调用失败)                                │
                     │                               │                                   │
                     ▼                               └────────────┐                      │
            ┌────────────────┐                                    │                      │
            │ Completed      │                                    │                      │
            │ (工具调用结果)  │                                    │                      │
            └────────────────┘                                    │                      │
                                                                      │                      │
                                          ┌──────────────────────────┴───────────────┐
                                          │                                          │
                                          ▼                                          ▼
                                   CapabilityFound                             NoCapabilityFound
                                          │                                          │
                                          ▼                                          │
                             ┌──────────────────────────┐                             │
                             │ ConsciousnessWithCap     │                             │
                             └────────────┬─────────────┘                             │
                                          │                                          │
                     ┌────────────────────┴────────────────────┐                      │
                     │                                          │                      │
                     ▼                                          ▼                      │
            ProcessingComplete                              Error                     │
                     │                                          │                      │
                     ▼                                          ▼                      │
            ┌────────────────┐                          ┌────────────────┐             │
            │ Completed      │                          │ Fallback       │             │
            └────────────────┘                          └───────┬────────┘             │
                                                                │                      │
                                                                ▼                      │
                                                        ProcessingComplete        │
                                                                │                      │
                                                                ▼                      │
                                                        ┌────────────────┐             │
                                                        │ Completed      │◀────────────┘
                                                        └────────────────┘
```

---

## 三、核心接口设计

### 3.1 状态机接口

```go
package brain

import (
    "context"
    "mindx/internal/core"
)

type StateMachine interface {
    Process(ctx context.Context, req *ThinkingRequest) (*ThinkingResponse, error)
    CurrentState() BrainState
    Transition(event BrainEvent) error
}

type StateContext struct {
    Request          *ThinkingRequest
    ProcessingCtx    *processingContext
    ThinkResult      *ThinkingResult
    Tools            []*ToolSchema
    Capability       *entity.Capability
    Response         *ThinkingResponse
    Error            error
    EventChan        chan<- ThinkingEvent
}

type StateHandler interface {
    Enter(ctx context.Context, stateCtx *StateContext) (BrainEvent, error)
    Exit(ctx context.Context, stateCtx *StateContext) error
}
```

### 3.2 状态机核心实现

```go
package brain

type BrainStateMachine struct {
    currentState BrainState
    handlers     StateHandlerRegistry
    transitions  map[BrainState]map[BrainEvent]BrainState
    mu           sync.RWMutex
    logger       logging.Logger
}

func (sm *BrainStateMachine) Process(ctx context.Context, req *ThinkingRequest) (*ThinkingResponse, error) {
    stateCtx := &StateContext{
        Request:   req,
        EventChan: req.EventChan,
    }

    event := EventStart

    for {
        sm.mu.Lock()
        currentState := sm.currentState
        
        nextStates := sm.transitions[currentState]
        nextState := nextStates[event]

        sm.currentState = nextState
        sm.mu.Unlock()

        sm.logger.Debug("state transition",
            logging.String("from", string(currentState)),
            logging.String("event", string(event)),
            logging.String("to", string(nextState)))

        handler := sm.handlers[nextState]
        event, err = handler.Enter(ctx, stateCtx)
        if err != nil {
            stateCtx.Error = err
            event = EventError
        }

        if nextState == StateCompleted || nextState == StateError {
            break
        }
    }

    return stateCtx.Response, stateCtx.Error
}
```

---

## 四、状态处理器示例

### 4.1 左脑思考状态处理器

```go
package brain

type LeftBrainThinkingHandler struct {
    leftBrain       core.Thinking
    contextPreparer *ContextPreparer
    logger          logging.Logger
}

func (h *LeftBrainThinkingHandler) Enter(ctx context.Context, stateCtx *StateContext) (BrainEvent, error) {
    h.logger.Info("entering left brain thinking state")

    h.leftBrain.SetEventChan(stateCtx.EventChan)
    defer h.leftBrain.SetEventChan(nil)

    thinkResult, err := h.leftBrain.Think(
        ctx,
        stateCtx.Request.Question,
        stateCtx.ProcessingCtx.historyDialogue,
        stateCtx.ProcessingCtx.refs,
        true,
    )
    if err != nil {
        return EventError, fmt.Errorf("left brain think failed: %w", err)
    }

    stateCtx.ThinkResult = thinkResult

    if thinkResult.HasSchedule {
        return EventScheduleDetected, nil
    }

    if thinkResult.CanAnswer && thinkResult.Answer != "" {
        stateCtx.Response = &ThinkingResponse{
            Answer: thinkResult.Answer,
            SendTo: thinkResult.SendTo,
        }
        return EventCanAnswer, nil
    }

    return EventCannotAnswer, nil
}
```

---

## 五、重构前后对比

| 维度 | 重构前 | 重构后 |
|------|--------|--------|
| **post() 方法行数** | ~250 行 | ~30 行（委托给状态机） |
| **嵌套层级** | 4-5 层 | 2 层（状态机循环） |
| **状态可见性** | 隐式（分散在条件判断中） | 显式（State 枚举） |
| **错误处理** | 分散在多处 | 统一在状态机循环 |
| **测试复杂度** | 需要模拟复杂条件组合 | 可独立测试每个状态处理器 |
| **扩展性** | 需修改 post() 方法 | 只需添加新状态和处理器 |

---

## 六、实施计划

### 6.1 阶段一：基础框架（1 周）

- [ ] 创建 `internal/usecase/brain/state/types.go` - 定义状态和事件枚举
- [ ] 创建 `internal/usecase/brain/state/context.go` - 定义状态上下文
- [ ] 创建 `internal/usecase/brain/state/machine.go` - 状态机核心实现
- [ ] 编写状态转换单元测试

### 6.2 阶段二：状态处理器实现（2 周）

- [ ] 实现 `PreparingContextHandler`
- [ ] 实现 `LeftBrainThinkingHandler`
- [ ] 实现 `RightBrainProcessingHandler`
- [ ] 实现 `ConsciousnessActivatingHandler`
- [ ] 实现 `FallbackStateHandler`

### 6.3 阶段三：集成与测试（1 周）

- [ ] 创建 `BionicBrainV2` 使用状态机
- [ ] 添加特性开关控制新旧实现
- [ ] 运行集成测试验证功能

---

**文档版本**: 1.0  
**最后更新**: 2026-02-23
