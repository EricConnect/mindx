# MindX 架构设计专项评估报告（P3 重构后）

**评估日期**: 2026-02-23
**评估基线**: 2026-02-22 首次评估（P0-P3 重构前）

---

## 一、整体架构模式

### 1.1 分层架构分析

分层结构与首次评估一致，无退化：

```
cmd/main.go                     → 应用入口
internal/adapters/              → 外部适配器层（CLI、HTTP、消息渠道）
internal/usecase/               → 业务逻辑层
internal/core/                  → 领域接口与核心类型定义
internal/entity/                → 领域实体
internal/infrastructure/        → 技术基础设施
pkg/                            → 可复用工具包
```

### 1.2 分层违规修复

上次评估指出 3 处 usecase→infrastructure 分层违规（`Store` 接口定义在错误的层）。

**当前状态：已修复。** `Store` 接口已移至 `internal/core/store.go`，usecase 层通过 core 层接口依赖 infrastructure 实现，依赖方向正确。

### 1.3 启动与依赖组装

`BionicBrain` 构造函数从 11 个独立参数改为 `BrainDeps` 结构体注入（`brain.go:23-34`），降低了耦合度，新增依赖只需在结构体中添加字段。

---

## 二、仿生大脑架构

认知处理管线（左脑→右脑→意识层）保持不变，这是项目的核心差异化设计。

`post()` 方法约 95 行（`brain.go:139-234`），嵌套 2-3 层，流程清晰。GLM-5 提出的状态机重构方案将其描述为"250 行、4-5 层嵌套"，与实际不符。当前实现无需状态机改造。

新增组件：
- `ContextPreparer` — 上下文准备逻辑独立
- `ResponseBuilder` — 响应构建逻辑独立
- `FallbackHandler` — 降级逻辑统一
- `ConsciousnessManager` — 意识层路由独立

---

## 三、渠道架构

### 3.1 代码重复消除

上次评估指出 14 个渠道实现存在大量重复模式。

**当前状态：已修复。** `WebhookChannel`（`webhook_channel.go`）作为基类，封装了 HTTP 服务器启停、统计计数、消息回调等公共逻辑。所有 Webhook 类渠道（钉钉、飞书、微信、QQ、WhatsApp、Facebook、Telegram）均继承自该基类。

### 3.2 断路器集成

所有 8 个渠道的消息发送均通过 `getBreaker(name).Execute()` 包装（`breaker.go`），使用 `pkg/circuitbreaker` 实现三态断路器（Closed→Open→HalfOpen）。

---

## 四、可靠性架构

### 4.1 重试机制

`pkg/retry/retry.go` 实现指数退避重试，`thinking.go` 中 LLM 调用有 3 处使用 `retry.DoWithResult()`。

### 4.2 Token 预算管理

`TokenBudgetManager`（`token_budget.go`）动态计算可用 Token 和历史对话轮数。上次评估指出未扣除系统提示开销的问题，当前实现中 `CalculateMaxHistoryCount()` 仍基于平均值估算，精度有限但可用。

---

## 五、领域建模

贫血模型问题仍然存在。`entity/` 包中的结构体仍为纯数据载体，无行为方法、无值对象、无聚合根、无领域事件。

这在当前项目规模下是可接受的——MindX 的核心复杂度在 AI 推理管线而非领域逻辑，过度的 DDD 建模反而增加不必要的抽象层。

---

## 六、并发与生命周期管理

- `context.Context` 在 brain 层已贯穿（`post()` 创建带超时的 context 并传递给所有子调用）
- 渠道层仍有较多 `context.Background()` 使用（约 199 处），部分应改为传递请求级 context
- BadgerDB 后台 GC goroutine 有正确的 `stopCh` 退出机制
- MockChannel 的 goroutine 泄漏已修复（`Stop()` 通过 `stopCh` 通知 `receiveLoop` 退出）

---

## 七、架构设计综合评分

| 维度 | 上次评分 | 当前评分 | 变化 | 说明 |
|------|---------|---------|------|------|
| 分层清晰度 | 8 | 8 | → | 保持良好 |
| 依赖方向 | 5 | 8 | ↑3 | Store 接口已移至 core 层，分层违规消除 |
| 领域建模 | 4 | 4 | → | 贫血模型未变，但对当前规模可接受 |
| 核心创新 | 9 | 9 | → | 仿生大脑架构保持独创性 |
| 并发安全 | 6 | 7 | ↑1 | BadgerDB GC 有退出机制，MockChannel 泄漏修复 |
| 状态管理 | 5 | 6 | ↑1 | BrainDeps 降低耦合，全局单例问题仍在 |
| 可扩展性 | 5 | 6 | ↑1 | 断路器和重试机制提升了系统韧性 |
| 模块化 | 7 | 8 | ↑1 | WebhookChannel 基类消除重复，brain 子组件拆分 |

**架构设计综合评分：7.0 / 10**（上次 6.1）
