# MindX P4 重构清单（基于 2026-02-23 评估报告）

**制定日期**: 2026-02-23
**评估基线**: P3 重构后综合评分 6.8/10
**目标**: 消除评估报告中剩余的高/中优先级问题

---

## 实施顺序

P4-1 → P4-2 → P4-3 → P4-4 → P4-5 → P4-6 → P4-7

优先级排序逻辑：先拆分大文件降低后续改动风险，再修复测试，再提升高频路径（Prompt 工程），再补齐运行时能力。

---

## P4-1: 记忆模块拆分

**优先级**: 高
**问题**: `memory.go` 1003 行、27 个方法、8 类职责混杂在单文件中。

**目标**: 按职责拆为 4-5 个文件，保持对外接口不变。

**当前方法分布**:

| 职责 | 方法数 | 行数（约） |
|------|--------|-----------|
| CRUD + 入口 | 5 | ~100 |
| 搜索 & 向量 | 7 | ~150 |
| 权重计算 | 4 | ~90 |
| LLM 集成（摘要/关键词） | 2 | ~100 |
| 清理 & 衰减 | 2 | ~80 |
| 聚类 & 优化 | 5 | ~350 |
| 工具函数 + 维护 | 2 | ~50 |

**拆分方案**:

```
internal/usecase/memory/
├── memory.go            ← 保留：MemoryManager 结构体定义、构造函数、Record()、Close()、StartPeriodicMaintenance()
├── search.go            ← 新建：Search()、filterByKeywords()、calculateKeywordSimilarity()、calculateCosineSimilarity()、simpleTokenize()、sortByWeight()
├── weight.go            ← 新建：calculateTimeWeight()、calculateRepeatWeight()、calculateEmphasisWeight()、calculateTotalWeight()
├── consolidation.go     ← 新建：Optimize()、ClusterConversations()、generateCombinedMemoryPoint()、determineOptimalK()、extractConversationContent()
├── llm_helpers.go       ← 新建：generateSummary()、generateKeywords()
├── maintenance.go       ← 新建：CleanupExpiredMemories()、DecayWeights()、getAllMemories()、GetAllMemoryPoints()、parseMemoryPoint()、generateMemoryKey()、storeMemory()
├── extractor.go         ← 已有，不动
├── dedup.go             ← 已有，不动
├── test_utils.go        ← 已有，不动
└── *_test.go            ← 已有测试不动
```

**原则**:
- 所有新文件 `package memory`，方法仍挂在 `*MemoryManager` 上
- 不改任何方法签名、不改对外接口
- 不引入新的抽象层或接口
- 拆分后每个文件 100-250 行

**验证**: `make test` 全部通过，`memory_interface_test.go` 和 `memory_internal_test.go` 无需修改。

---

## P4-2: Gateway 测试修复

**优先级**: 高
**问题**: `gateway_stability_test.go` 中消息计数断言失败。

**根因**: `HandleMessage()` 中 `syncToRealTimeChannel()` 会为每条非实时渠道消息额外产生 1-2 条同步消息（入站同步 + 应答同步），但测试断言只计算了原始消息数。

**消息流**:
1. 非实时渠道收到消息 → `syncToRealTimeChannel()` 发 1 条（入站同步）
2. `onMessage()` 处理得到应答
3. 应答存在且来源非实时 → `syncToRealTimeChannel()` 再发 1 条（应答同步）
4. `sendToChannel()` 发送应答到原渠道

**修复方案**: 修正测试中的消息计数期望值，使其包含 `syncToRealTimeChannel` 产生的同步消息。具体需要：
- 审查每个失败的测试用例，计算实际消息流（含同步消息）
- 调整 `assert` 中的期望值
- 如果 `syncToRealTimeChannel` 的行为本身有 bug（如不应该同步某些消息），则修复 Gateway 逻辑

**文件**: `internal/adapters/channels/gateway_stability_test.go`、`internal/adapters/channels/gateway.go`

---

## P4-3: 左脑 Prompt 工程

**优先级**: 高
**问题**: 左脑意图识别是每条消息必经的高频路径，当前 Prompt 质量直接制约分流准确率。

**当前问题分析**:

| 问题 | 说明 |
|------|------|
| Few-shot 不足 | local 模板 3 个示例、cloud 模板 2 个示例，边界 case 零覆盖 |
| 无 CoT 引导 | 思考步骤是平铺列表，未引导模型逐步推理 |
| cloud 模板缺 `can_answer` | `left_brain_cloud.tmpl` 无 `can_answer` 规则，云模型无法判断是否需要工具 |
| 边界 case 未覆盖 | 多意图（"查天气然后提醒我"）、否定句（"不用了"）、模糊意图（"帮我看看"）无示例 |
| fallback 与模板重复 | `prompt_builder.go` 硬编码 fallback prompt 与 `.tmpl` 内容重复维护 |
| 纯中文 prompt | 示例和规则全中文，对英文输入的意图识别可能偏弱 |

**改动文件**:
- `prompts/left_brain_local.tmpl`
- `prompts/left_brain_cloud.tmpl`
- `internal/core/prompt_builder.go`（fallback 同步更新）

**改动方案**:

1. **补齐 cloud 模板的 `can_answer` 规则**：从 local 模板同步 `can_answer` 规则和 `{{ .SkillKeywords }}` 占位符

2. **增加 Few-shot 示例到 6-8 个**，覆盖边界 case：
   - 多意图："查一下北京天气，然后每天早上提醒我带伞" → `has_schedule=true` + `can_answer=false`
   - 否定/取消："算了不用了" → `useless=true`
   - 模糊意图："帮我看看这个" → `can_answer=false`（需要上下文，交给右脑）
   - 纯英文输入："What's the weather in Beijing?" → 正确识别意图
   - 闲聊但有信息："我今天心情不好" → `useless=false`（可能需要安慰，不是无意义闲聊）
   - 工具调用明确："帮我算一下 123*456" → `can_answer=false`, `intent=计算`

3. **思考步骤改为 CoT 引导格式**：
   ```
   ## 思考步骤（请在内心逐步推理，不要输出推理过程）

   1. 用户说了什么？→ 提取核心诉求
   2. 这是闲聊还是有具体需求？→ 判断 useless
   3. 需要实时数据/外部工具，还是常识就能回答？→ 判断 can_answer
   4. 是否包含定时/转发意图？→ 判断 schedule/send_to
   5. 如果有多个意图，以主要意图为准
   ```

4. **消除 fallback 与模板的重复**：`prompt_builder.go` 中 `buildFallbackPrompt()` 改为加载模板渲染，不再维护独立的硬编码 prompt

**验证**:
- `make test` 通过
- `core/prompt_builder_test.go` 验证模板渲染输出包含新增示例和 CoT 步骤
- 手动测试：`mindx tui` 中输入边界 case 验证意图识别准确率

---

## P4-4: 渠道层 context 传播（原 P4-3）

**优先级**: 中
**问题**: 渠道层 5 处消息回调使用 `context.Background()`，无法感知 Gateway 生命周期。

**需修改的位置**:

| 文件 | 行 | 当前 | 改为 |
|------|----|------|------|
| `qq.go` | 252 | `context.Background()` | 从 `QQChannel` 结构体获取 ctx |
| `qq.go` | 315 | `context.Background()` | 同上 |
| `webhook_channel.go` | 127 | `context.Background()` | 从 `WebhookChannel` 结构体获取 ctx |
| `wechat.go` | 360 | `context.Background()` | 从 `WeChatChannel` 结构体获取 ctx |
| `realtime.go` | 526 | `context.Background()` | 从 `WebSocketRealtimeChannel` 结构体获取 ctx |

**方案**: 各渠道 `Start()` 时保存 `ctx` 到结构体字段，消息回调使用该 ctx 派生子 context。`gateway.go:39` 和 shutdown timeout 处的 `context.Background()` 保持不变（属于合理用法）。

---

## P4-5: WebSocket 服务端心跳

**优先级**: 中
**问题**: WebSocket 无服务端 ping/pong，客户端无法感知连接是否存活。

**文件**: `internal/adapters/channels/realtime.go`

**方案**:
- 连接建立后启动心跳 goroutine，每 30 秒发送 ping
- 设置 pong 超时（60 秒），超时则关闭连接
- 客户端（TUI 和 Dashboard）已有重连逻辑，服务端主动断开后会自动重连

---

## P4-6: AdvancedSettings 组件拆分

**优先级**: 中
**问题**: `AdvancedSettings.tsx` 628 行，包含 7 个配置区域。

**拆分方案**:

```
dashboard/src/components/settings/
├── types.ts                  ← 接口定义（GeneralConfig、MemoryConfig 等）
├── PersonaSection.tsx        ← 人设配置
├── MemorySection.tsx         ← 记忆配置
├── TokenBudgetSection.tsx    ← Token 预算配置
├── ModelSection.tsx          ← 模型配置
├── ScheduleSection.tsx       ← 定时任务配置
├── LogSection.tsx            ← 日志配置
└── DangerZone.tsx            ← 危险操作区
```

`AdvancedSettings.tsx` 保留为编排组件，管理 state 和 API 调用，子组件通过 props 接收数据和回调。

---

## P4-7: 前端测试基础设施

**优先级**: 中
**问题**: 前端零测试。

**方案**:
- 安装 Vitest + React Testing Library + jsdom
- 为已拆分的子组件编写基础渲染测试（SkillCard、ChannelCard、SkillFilters）
- CI 流水线 frontend job 添加 `npm run test`
- 不追求高覆盖率，先建立基础设施和示范用例

---

## 不纳入本轮的项目

以下项目在评估报告中列为低优先级，暂不实施：

| 项目 | 原因 |
|------|------|
| 配置热更新 | 使用频率低，重启即可 |
| 分布式追踪（Trace ID） | 单机部署场景下优先级低 |
| 领域建模（贫血模型） | 当前规模下 DDD 建模收益不大 |
| 全局单例 ModelsManager | 影响范围有限 |

---

## 预期收益

| 维度 | 当前评分 | 预期提升 |
|------|---------|---------|
| 代码质量 | 7 | → 8（记忆拆分 + 组件拆分） |
| 测试覆盖 | 6 | → 7（Gateway 修复 + 前端测试） |
| 技术深度 | 6 | → 7（Prompt 工程 + context 传播 + WebSocket 心跳） |
| 前端质量 | 7 | → 8（组件拆分 + 测试） |
| 应用体验 | 7 | → 8（意图识别准确率提升） |
